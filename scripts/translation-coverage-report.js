#!/usr/bin/env node

const fs = require('fs');
const path = require('path');

const LANGUAGES = ['en', 'es', 'fr', 'de', 'it', 'pt', 'ar', 'hi', 'sw', 'zh'];
const NAMESPACES = ['common', 'navigation', 'auth', 'lore', 'profile', 'admin', 'errors'];

function generateCoverageReport() {
  console.log('# ğŸŒ Translation Coverage Report\n');
  console.log('This PR includes automatic translation updates.\n');
  
  const stats = {};
  let totalKeys = 0;
  let totalTranslated = 0;
  
  // Calculate coverage per language
  for (const lang of LANGUAGES) {
    stats[lang] = {
      total: 0,
      translated: 0,
      namespaces: {}
    };
    
    for (const namespace of NAMESPACES) {
      const englishPath = path.join('public', 'locales', 'en', `${namespace}.json`);
      const targetPath = path.join('public', 'locales', lang, `${namespace}.json`);
      
      if (!fs.existsSync(englishPath)) continue;
      
      const englishContent = JSON.parse(fs.readFileSync(englishPath, 'utf8'));
      const englishKeys = countKeys(englishContent);
      
      let targetKeys = 0;
      if (fs.existsSync(targetPath)) {
        const targetContent = JSON.parse(fs.readFileSync(targetPath, 'utf8'));
        targetKeys = countNonEmptyKeys(targetContent);
      }
      
      stats[lang].namespaces[namespace] = {
        total: englishKeys,
        translated: targetKeys,
        percentage: Math.round((targetKeys / englishKeys) * 100)
      };
      
      stats[lang].total += englishKeys;
      stats[lang].translated += targetKeys;
    }
    
    if (lang === 'en') {
      totalKeys = stats[lang].total;
    }
    totalTranslated += stats[lang].translated;
  }
  
  // Generate summary table
  console.log('## ğŸ“Š Overall Coverage\n');
  console.log('| Language | Coverage | Translated | Total |');
  console.log('|----------|----------|-----------|-------|');
  
  for (const lang of LANGUAGES) {
    const percentage = Math.round((stats[lang].translated / stats[lang].total) * 100);
    const bar = generateProgressBar(percentage);
    console.log(`| ${getLanguageEmoji(lang)} ${lang.toUpperCase()} | ${bar} ${percentage}% | ${stats[lang].translated} | ${stats[lang].total} |`);
  }
  
  // Namespace breakdown
  console.log('\n## ğŸ“ Coverage by Namespace\n');
  
  for (const namespace of NAMESPACES) {
    console.log(`### ${namespace}\n`);
    console.log('| Language | Coverage | Keys |');
    console.log('|----------|----------|------|');
    
    for (const lang of LANGUAGES) {
      if (lang === 'en') continue;
      const ns = stats[lang].namespaces[namespace];
      if (!ns) continue;
      const bar = generateProgressBar(ns.percentage);
      console.log(`| ${getLanguageEmoji(lang)} ${lang.toUpperCase()} | ${bar} ${ns.percentage}% | ${ns.translated}/${ns.total} |`);
    }
    console.log('');
  }
  
  // Overall stats
  const overallPercentage = Math.round((totalTranslated / (totalKeys * (LANGUAGES.length - 1))) * 100);
  console.log(`\n## ğŸ¯ Summary\n`);
  console.log(`- **Total Keys**: ${totalKeys} per language`);
  console.log(`- **Languages**: ${LANGUAGES.length}`);
  console.log(`- **Overall Coverage**: ${overallPercentage}%`);
  console.log(`- **Total Translations**: ${totalTranslated} / ${totalKeys * (LANGUAGES.length - 1)}`);
  
  console.log('\n---\n');
  console.log('*This report was automatically generated by the translation sync workflow.*');
}

function countKeys(obj, count = 0) {
  for (const key in obj) {
    if (typeof obj[key] === 'object' && obj[key] !== null) {
      count = countKeys(obj[key], count);
    } else {
      count++;
    }
  }
  return count;
}

function countNonEmptyKeys(obj, count = 0) {
  for (const key in obj) {
    if (typeof obj[key] === 'object' && obj[key] !== null) {
      count = countNonEmptyKeys(obj[key], count);
    } else if (obj[key] && obj[key].trim() !== '') {
      count++;
    }
  }
  return count;
}

function generateProgressBar(percentage) {
  const filled = Math.round(percentage / 10);
  const empty = 10 - filled;
  return 'â–ˆ'.repeat(filled) + 'â–‘'.repeat(empty);
}

function getLanguageEmoji(code) {
  const emojis = {
    en: 'ğŸ‡¬ğŸ‡§',
    es: 'ğŸ‡ªğŸ‡¸',
    fr: 'ğŸ‡«ğŸ‡·',
    de: 'ğŸ‡©ğŸ‡ª',
    it: 'ğŸ‡®ğŸ‡¹',
    pt: 'ğŸ‡µğŸ‡¹',
    ar: 'ğŸ‡¸ğŸ‡¦',
    hi: 'ğŸ‡®ğŸ‡³',
    sw: 'ğŸ‡°ğŸ‡ª',
    zh: 'ğŸ‡¨ğŸ‡³'
  };
  return emojis[code] || 'ğŸŒ';
}

generateCoverageReport();
